# Lyss AI Platform 数据库设计文档

**版本**: 2.0  
**更新时间**: 2025-01-25  
**数据库**: PostgreSQL 15+ + Redis + ClickHouse  
**状态**: 已确认

---

## 设计原则

### 核心设计理念
1. **微服务数据隔离**: 每个微服务拥有独立的数据模式
2. **ACID 完整性**: 严格事务控制，确保数据一致性
3. **性能优化**: 合理索引设计，支持高并发查询
4. **扩展性**: 支持水平分片和读写分离
5. **安全性**: 敏感数据加密存储，访问权限控制

### 命名规范
- **表名**: 小写蛇形命名 `user_profiles`
- **字段名**: 小写蛇形命名 `created_at`
- **索引名**: `idx_表名_字段名` 格式
- **外键名**: `fk_表名_关联表名` 格式

---

## 数据库架构总览

### 微服务数据库分布

```
lyss_platform
├── user_service_db      # 用户服务数据库
├── auth_service_db      # 认证服务数据库  
├── group_service_db     # 群组服务数据库
├── credential_service_db # 凭证服务数据库
├── gateway_service_db   # 网关服务数据库
├── billing_service_db   # 计费服务数据库
└── shared_db           # 共享配置数据库
```

### 跨服务数据一致性策略
- **分布式事务**: 使用 Saga 模式处理跨服务事务
- **事件溯源**: 关键业务操作记录事件日志
- **最终一致性**: 异步消息确保数据同步

---

## 用户服务数据库 (user_service_db)

### 用户基础表 (users)
```sql
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    display_name VARCHAR(100),
    avatar_url VARCHAR(500),
    status SMALLINT DEFAULT 1,  -- 1:活跃 2:冻结 3:删除
    role SMALLINT DEFAULT 1,    -- 1:普通用户 2:管理员 3:超级管理员
    email_verified BOOLEAN DEFAULT FALSE,
    last_login_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引设计
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_users_created_at ON users(created_at);
```

### 用户配置表 (user_settings)
```sql
CREATE TABLE user_settings (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    setting_key VARCHAR(100) NOT NULL,
    setting_value JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_user_settings_user_id 
        FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    CONSTRAINT uk_user_settings_user_key 
        UNIQUE (user_id, setting_key)
);

CREATE INDEX idx_user_settings_user_id ON user_settings(user_id);
```

### 用户配额表 (user_quotas)
```sql
CREATE TABLE user_quotas (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    total_quota BIGINT DEFAULT 0,      -- 总配额 (tokens)
    used_quota BIGINT DEFAULT 0,       -- 已用配额
    daily_limit BIGINT DEFAULT 0,      -- 日配额限制
    monthly_limit BIGINT DEFAULT 0,    -- 月配额限制
    quota_reset_at DATE,               -- 配额重置日期
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_user_quotas_user_id 
        FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    CONSTRAINT uk_user_quotas_user_id UNIQUE (user_id)
);

CREATE INDEX idx_user_quotas_user_id ON user_quotas(user_id);
```

---

## 认证服务数据库 (auth_service_db)

### JWT 令牌表 (jwt_tokens)
```sql
CREATE TABLE jwt_tokens (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    token_hash VARCHAR(255) NOT NULL,  -- JWT token 的 hash
    refresh_token_hash VARCHAR(255),   -- Refresh token 的 hash
    expires_at TIMESTAMP NOT NULL,
    refresh_expires_at TIMESTAMP,
    is_revoked BOOLEAN DEFAULT FALSE,
    device_info JSONB,                 -- 设备信息
    ip_address INET,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT uk_jwt_tokens_token_hash UNIQUE (token_hash)
);

CREATE INDEX idx_jwt_tokens_user_id ON jwt_tokens(user_id);
CREATE INDEX idx_jwt_tokens_expires_at ON jwt_tokens(expires_at);
CREATE INDEX idx_jwt_tokens_is_revoked ON jwt_tokens(is_revoked);
```

### OAuth 集成表 (oauth_connections)
```sql
CREATE TABLE oauth_connections (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    provider VARCHAR(50) NOT NULL,     -- github, google, wechat
    provider_user_id VARCHAR(100) NOT NULL,
    access_token_encrypted TEXT,       -- 加密存储
    refresh_token_encrypted TEXT,
    token_expires_at TIMESTAMP,
    user_info JSONB,                   -- 用户在第三方平台的信息
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT uk_oauth_provider_user 
        UNIQUE (provider, provider_user_id)
);

CREATE INDEX idx_oauth_connections_user_id ON oauth_connections(user_id);
CREATE INDEX idx_oauth_connections_provider ON oauth_connections(provider);
```

---

## 群组服务数据库 (group_service_db)

### 群组基础表 (groups)
```sql
CREATE TABLE groups (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    avatar_url VARCHAR(500),
    is_public BOOLEAN DEFAULT FALSE,   -- 是否公开可搜索
    join_mode SMALLINT DEFAULT 1,      -- 1:邀请制 2:申请制 3:开放制
    max_members INTEGER DEFAULT 50,
    status SMALLINT DEFAULT 1,         -- 1:正常 2:冻结 3:解散
    owner_user_id BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_groups_owner_user_id ON groups(owner_user_id);
CREATE INDEX idx_groups_status ON groups(status);
CREATE INDEX idx_groups_is_public ON groups(is_public);
```

### 群组成员表 (group_members)
```sql
CREATE TABLE group_members (
    id BIGSERIAL PRIMARY KEY,
    group_id BIGINT NOT NULL,
    user_id BIGINT NOT NULL,
    role SMALLINT DEFAULT 1,           -- 1:成员 2:管理员 3:群主
    status SMALLINT DEFAULT 1,         -- 1:正常 2:禁言 3:踢出
    joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_group_members_group_id 
        FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE,
    CONSTRAINT uk_group_members_group_user 
        UNIQUE (group_id, user_id)
);

CREATE INDEX idx_group_members_group_id ON group_members(group_id);
CREATE INDEX idx_group_members_user_id ON group_members(user_id);
CREATE INDEX idx_group_members_role ON group_members(role);
```

### 群组邀请表 (group_invitations)
```sql
CREATE TABLE group_invitations (
    id BIGSERIAL PRIMARY KEY,
    group_id BIGINT NOT NULL,
    inviter_user_id BIGINT NOT NULL,
    invitee_email VARCHAR(255),
    invitee_user_id BIGINT,
    invitation_code VARCHAR(50) UNIQUE NOT NULL,
    status SMALLINT DEFAULT 1,         -- 1:待处理 2:已接受 3:已拒绝 4:已过期
    expires_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    processed_at TIMESTAMP,
    
    CONSTRAINT fk_group_invitations_group_id 
        FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE
);

CREATE INDEX idx_group_invitations_invitation_code ON group_invitations(invitation_code);
CREATE INDEX idx_group_invitations_group_id ON group_invitations(group_id);
CREATE INDEX idx_group_invitations_status ON group_invitations(status);
```

---

## 凭证服务数据库 (credential_service_db)

### 供应商凭证表 (provider_credentials)
```sql
CREATE TABLE provider_credentials (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    provider_type VARCHAR(50) NOT NULL, -- openai, claude, gemini
    scope VARCHAR(20) NOT NULL,         -- personal, group
    scope_id BIGINT NOT NULL,           -- user_id 或 group_id
    api_key_encrypted TEXT NOT NULL,    -- 加密存储的 API Key
    api_endpoint VARCHAR(500),
    model_config JSONB,                 -- 模型配置 (temperature, max_tokens等)
    rate_limit_config JSONB,            -- 速率限制配置
    status SMALLINT DEFAULT 1,          -- 1:正常 2:禁用 3:异常
    last_used_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_provider_credentials_scope ON provider_credentials(scope, scope_id);
CREATE INDEX idx_provider_credentials_provider_type ON provider_credentials(provider_type);
CREATE INDEX idx_provider_credentials_status ON provider_credentials(status);
```

### 模型权限表 (model_permissions)
```sql
CREATE TABLE model_permissions (
    id BIGSERIAL PRIMARY KEY,
    credential_id BIGINT NOT NULL,
    model_name VARCHAR(100) NOT NULL,
    is_enabled BOOLEAN DEFAULT TRUE,
    priority INTEGER DEFAULT 0,        -- 优先级，数字越大优先级越高
    weight INTEGER DEFAULT 1,          -- 负载均衡权重
    daily_quota BIGINT,                -- 日配额限制
    monthly_quota BIGINT,              -- 月配额限制
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_model_permissions_credential_id 
        FOREIGN KEY (credential_id) REFERENCES provider_credentials(id) ON DELETE CASCADE,
    CONSTRAINT uk_model_permissions_credential_model 
        UNIQUE (credential_id, model_name)
);

CREATE INDEX idx_model_permissions_credential_id ON model_permissions(credential_id);
CREATE INDEX idx_model_permissions_model_name ON model_permissions(model_name);
```

---

## 网关服务数据库 (gateway_service_db)

### API 请求日志表 (api_request_logs)
```sql
CREATE TABLE api_request_logs (
    id BIGSERIAL PRIMARY KEY,
    request_id VARCHAR(100) UNIQUE NOT NULL,
    user_id BIGINT,
    group_id BIGINT,
    credential_id BIGINT,
    model_name VARCHAR(100),
    provider_type VARCHAR(50),
    method VARCHAR(10),
    endpoint VARCHAR(500),
    request_size INTEGER,
    response_size INTEGER,
    status_code INTEGER,
    duration_ms INTEGER,
    error_message TEXT,
    request_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- 分区字段
    PARTITION BY RANGE (request_time)
);

-- 创建分区表 (按月分区)
CREATE TABLE api_request_logs_2025_01 PARTITION OF api_request_logs
    FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');

CREATE INDEX idx_api_request_logs_user_id ON api_request_logs(user_id);
CREATE INDEX idx_api_request_logs_request_time ON api_request_logs(request_time);
CREATE INDEX idx_api_request_logs_status_code ON api_request_logs(status_code);
```

### 路由配置表 (routing_rules)
```sql
CREATE TABLE routing_rules (
    id BIGSERIAL PRIMARY KEY,
    rule_name VARCHAR(100) NOT NULL,
    model_pattern VARCHAR(100),         -- 模型名称匹配规则
    user_group_pattern VARCHAR(100),    -- 用户组匹配规则
    routing_strategy SMALLINT DEFAULT 1, -- 1:轮询 2:权重 3:最少连接
    fallback_strategy JSONB,           -- 失败回退策略
    is_enabled BOOLEAN DEFAULT TRUE,
    priority INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_routing_rules_is_enabled ON routing_rules(is_enabled);
CREATE INDEX idx_routing_rules_priority ON routing_rules(priority);
```

---

## 计费服务数据库 (billing_service_db)

### 使用记录表 (usage_records)
```sql
CREATE TABLE usage_records (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    group_id BIGINT,
    credential_id BIGINT NOT NULL,
    request_id VARCHAR(100) NOT NULL,
    model_name VARCHAR(100) NOT NULL,
    provider_type VARCHAR(50) NOT NULL,
    
    -- Token 统计
    prompt_tokens INTEGER DEFAULT 0,
    completion_tokens INTEGER DEFAULT 0,
    total_tokens INTEGER DEFAULT 0,
    
    -- 成本计算
    input_cost DECIMAL(15,8) DEFAULT 0,    -- 输入成本 (USD)
    output_cost DECIMAL(15,8) DEFAULT 0,   -- 输出成本 (USD)  
    total_cost DECIMAL(15,8) DEFAULT 0,    -- 总成本 (USD)
    
    -- 时间信息
    usage_date DATE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- 分区字段
    PARTITION BY RANGE (usage_date)
);

-- 创建分区表 (按月分区)
CREATE TABLE usage_records_2025_01 PARTITION OF usage_records
    FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');

CREATE INDEX idx_usage_records_user_id ON usage_records(user_id);
CREATE INDEX idx_usage_records_usage_date ON usage_records(usage_date);
CREATE INDEX idx_usage_records_group_id ON usage_records(group_id);
```

### 计费规则表 (pricing_models)
```sql
CREATE TABLE pricing_models (
    id BIGSERIAL PRIMARY KEY,
    provider_type VARCHAR(50) NOT NULL,
    model_name VARCHAR(100) NOT NULL,
    input_price_per_1k DECIMAL(10,8) NOT NULL,   -- 每1K input tokens价格
    output_price_per_1k DECIMAL(10,8) NOT NULL,  -- 每1K output tokens价格
    currency VARCHAR(10) DEFAULT 'USD',
    effective_date DATE NOT NULL,
    expiry_date DATE,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT uk_pricing_models_provider_model_date 
        UNIQUE (provider_type, model_name, effective_date)
);

CREATE INDEX idx_pricing_models_provider_model ON pricing_models(provider_type, model_name);
CREATE INDEX idx_pricing_models_effective_date ON pricing_models(effective_date);
```

### 账单汇总表 (billing_summaries)
```sql
CREATE TABLE billing_summaries (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    group_id BIGINT,
    billing_period DATE NOT NULL,       -- 账单周期 (YYYY-MM-01)
    
    -- 统计数据
    total_requests INTEGER DEFAULT 0,
    total_tokens BIGINT DEFAULT 0,
    total_cost DECIMAL(15,2) DEFAULT 0,
    
    -- 按供应商分组统计
    provider_breakdown JSONB,           -- {provider: {requests, tokens, cost}}
    
    status SMALLINT DEFAULT 1,          -- 1:计算中 2:已确认 3:已支付
    generated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    confirmed_at TIMESTAMP,
    
    CONSTRAINT uk_billing_summaries_user_period 
        UNIQUE (user_id, group_id, billing_period)
);

CREATE INDEX idx_billing_summaries_user_id ON billing_summaries(user_id);
CREATE INDEX idx_billing_summaries_billing_period ON billing_summaries(billing_period);
```

---

## 共享配置数据库 (shared_db)

### 系统配置表 (system_configs)
```sql
CREATE TABLE system_configs (
    id BIGSERIAL PRIMARY KEY,
    config_key VARCHAR(100) UNIQUE NOT NULL,
    config_value JSONB,
    description TEXT,
    is_encrypted BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_system_configs_config_key ON system_configs(config_key);
```

### 通知消息表 (notifications)
```sql
CREATE TABLE notifications (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT,
    group_id BIGINT,
    title VARCHAR(200) NOT NULL,
    content TEXT,
    type SMALLINT DEFAULT 1,           -- 1:系统 2:配额 3:安全 4:业务
    priority SMALLINT DEFAULT 1,       -- 1:普通 2:重要 3:紧急
    is_read BOOLEAN DEFAULT FALSE,
    read_at TIMESTAMP,
    expires_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_notifications_user_id ON notifications(user_id);
CREATE INDEX idx_notifications_is_read ON notifications(is_read);
CREATE INDEX idx_notifications_created_at ON notifications(created_at);
```

---

## 性能优化策略

### 分区策略
1. **时间分区**: 日志和使用记录按月分区
2. **哈希分区**: 大表按 user_id 哈希分区
3. **范围分区**: 历史数据按时间范围分区

### 索引优化
1. **复合索引**: 常用查询条件组合建立复合索引
2. **部分索引**: 针对特定条件建立部分索引
3. **表达式索引**: JSON 字段的特定路径建立索引

### 查询优化
```sql
-- JSON 索引示例
CREATE INDEX idx_user_settings_value_gin ON user_settings USING GIN (setting_value);

-- 部分索引示例  
CREATE INDEX idx_users_active ON users(id) WHERE status = 1;

-- 复合索引示例
CREATE INDEX idx_usage_records_user_date ON usage_records(user_id, usage_date);
```

---

## 数据安全策略

### 加密存储
1. **API Key**: 使用 AES-256 加密
2. **OAuth Token**: 使用 AES-256 加密
3. **敏感配置**: 使用 PostgreSQL 内置加密

### 访问控制
1. **行级安全**: 启用 RLS (Row Level Security)
2. **角色权限**: 不同服务使用不同数据库角色
3. **审计日志**: 敏感表操作记录审计日志

### 数据备份
1. **热备份**: WAL 日志连续归档
2. **冷备份**: 每日全量备份
3. **跨区域备份**: 异地灾备

---

## 监控和维护

### 性能监控
1. **慢查询**: 监控执行时间超过 100ms 的查询
2. **连接池**: 监控数据库连接使用情况
3. **表空间**: 监控磁盘空间使用率

### 自动化维护
1. **统计信息更新**: 定期更新表统计信息
2. **索引重建**: 定期重建碎片化索引
3. **分区维护**: 自动创建和删除分区

### 告警规则
```sql
-- 监控查询示例
SELECT schemaname, tablename, n_tup_ins, n_tup_upd, n_tup_del 
FROM pg_stat_user_tables 
WHERE n_tup_ins + n_tup_upd + n_tup_del > 10000;
```

---

## 数据迁移策略

### 版本控制
1. **Schema 版本**: 使用 Flyway 进行数据库版本管理
2. **变更脚本**: 所有 DDL 变更通过脚本执行
3. **回滚计划**: 每个变更都有对应回滚脚本

### 迁移最佳实践
1. **增量迁移**: 大表数据分批迁移
2. **零停机**: 使用影子表进行在线迁移
3. **数据校验**: 迁移后进行数据一致性校验

---

## 附录

### 常用查询语句
```sql
-- 查看用户配额使用情况
SELECT u.username, uq.total_quota, uq.used_quota, 
       (uq.used_quota::float / uq.total_quota * 100) as usage_percent
FROM users u 
JOIN user_quotas uq ON u.id = uq.user_id
WHERE uq.used_quota::float / uq.total_quota > 0.8;

-- 查看群组成员统计
SELECT g.name, COUNT(gm.user_id) as member_count
FROM groups g
LEFT JOIN group_members gm ON g.id = gm.group_id AND gm.status = 1
GROUP BY g.name;

-- 查看 API 调用统计
SELECT provider_type, model_name, COUNT(*) as request_count,
       AVG(duration_ms) as avg_duration
FROM api_request_logs 
WHERE request_time >= CURRENT_DATE - INTERVAL '7 days'
GROUP BY provider_type, model_name
ORDER BY request_count DESC;
```

### 数据字典
详细的表结构和字段说明请参考自动生成的数据字典文档。

---

*本文档将随着项目发展持续更新，确保数据库设计与业务需求保持同步。*