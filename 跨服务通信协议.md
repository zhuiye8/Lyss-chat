# Lyss AI Platform - 跨服务通信协议

版本：1.0
状态：草案

## 1. 概述

本文档定义了 Lyss AI Platform 内部各微服务之间进行通信的标准协议和指导原则。选择合适的通信方式对于保证系统的高性能、高可用和松耦合至关重要。

## 2. 通信模式

本项目将采用两种主要的通信模式：**同步通信**和**异步通信**。

### 2.1. 同步通信 (Synchronous Communication)

#### 2.1.1. 协议

所有同步通信**必须**采用 **RESTful API** 调用，遵循《统一技术规范文档》中定义的API设计规范。

#### 2.1.2. 适用场景

当一个服务需要立即从另一个服务获取数据或操作结果，并且该操作是其业务流程的关键路径时，**必须**使用同步通信。

**示例场景:**

- **用户认证**: 网关服务调用认证服务，验证用户JWT并获取用户信息，必须立即知道结果才能决定是否放行。
- **凭证校验**: 网关服务在处理AI请求时，调用凭证服务获取并校验API Key的有效性。
- **权限检查**: 群组服务调用用户服务，确认某用户是否存在，以便添加其为成员。

#### 2.1.3. 服务发现

V1.0阶段，服务间的地址将通过环境变量进行配置。未来的版本将考虑引入更动态的服务发现机制（如Consul或Etcd）。

### 2.2. 异步通信 (Asynchronous Communication)

#### 2.2.1. 协议

所有异步通信**必须**通过**消息队列 (Message Queue)** 来实现。这有助于服务解耦，提高系统的弹性和可伸缩性。

#### 2.2.2. 适用场景

当一个操作耗时较长、不要求立即返回结果，或者可以接受最终一致性时，**推荐**使用异步通信。

**示例场景:**

- **发送通知**: 用户成功加入群组后，群组服务向消息队列发布一条“用户加入”的消息，由独立的通知服务消费该消息并向用户发送欢迎邮件或站内信。
- **聚合计费数据**: 网关服务在完成一次AI调用后，将详细的计费信息（Token用量、模型等）作为消息发送到队列，由计费服务异步地进行消费、统计和入库。
- **日志聚合**: 各服务将日志推送到消息队列，由一个统一的日志处理服务进行收集和存储。

#### 2.2.3. 技术选型：RabbitMQ

**结论: 本项目V1.0阶段选用 RabbitMQ 作为消息队列中间件。**

**选型理由:**

1.  **成熟稳定与易用性**: RabbitMQ 是一个非常成熟的消息代理，拥有广泛的社区支持和完善的文档。相比Kafka，它的部署和管理更为简单，有助于我们快速迭代开发。
2.  **灵活的路由功能**: RabbitMQ 提供了强大的交换机（Exchange）模型，支持多种路由策略（如 direct, topic, fanout），非常适合微服务架构中复杂的任务分发和消息路由需求。例如，我们可以轻松实现将特定类型的日志路由到专门的分析服务。
3.  **功能匹配度高**: 对于我们当前的核心异步场景，如**计费信息聚合**和**事件通知**，RabbitMQ 的任务队列模型是经典且高效的解决方案。
4.  **资源占用适中**: 对于项目初期可以预见的负载，RabbitMQ 的性能和资源占用完全可以满足需求，避免了使用更重量级系统（如Kafka）可能带来的过度设计和更高的运维成本。

**候选方案评估总结:**

| 评估维度 | RabbitMQ | Kafka |
| :--- | :--- | :--- |
| **核心模型** | 消息代理 (Smart Broker) | 分布式日志流 (Dumb Pipe) |
| **路由能力** | **非常灵活，强大** | 相对简单，基于Topic |
| **吞吐量** | 高 (万级/秒) | **极高 (百万级/秒)** |
| **部署维护** | **相对简单** | 相对复杂 |
| **本项目V1.0契合度** | **高** | 中 (部分场景过度设计) |
