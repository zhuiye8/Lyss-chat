# Lyss AI Platform - 统一技术规范文档 (V2.0 Kratos版)

## 1. 介绍

本文档是 Lyss AI Platform 所有微服务开发必须遵守的统一技术规范。其目的是确保代码风格一致、API接口标准化、数据持久化可靠、日志记录规范化，从而让所有AI或人类开发者能够高效、无歧义地协作。

**核心原则**: 本项目将全面采用 **[Kratos](https://go-kratos.dev/)** 作为统一的微服务框架。本文档中的所有规范，都是在**遵循Kratos框架最佳实践的基础上**，针对本平台业务需求的进一步明确和补充。当本文档与Kratos官方文档冲突时，以本文档为准。

## 2. API 设计规范

### 2.1. 协议

- **对外服务 (API网关)**: **必须**同时暴露 **HTTP/RESTful** 和 **gRPC** 两种接口。HTTP接口供前端和外部客户端调用，gRPC接口供内部服务调用。
- **对内服务 (内部微服务)**: **必须**暴露 **gRPC** 接口，**可以不**暴露HTTP接口。

### 2.2. 接口定义

- **必须**使用 **Protocol Buffers (Protobuf)** 作为唯一的接口定义语言（IDL）。
- 在 `.proto` 文件中，**必须**使用 `google.api.http` 注解来定义HTTP路由和参数绑定，以实现gRPC与HTTP接口的自动映射。

### 2.3. URL 结构与版本控制

- **必须**遵循Kratos的生成规则，并包含版本号。
- 格式: `/api/{service_name}/{version}/{resource}`
- 示例: `/api/user/v1/register`

### 2.4. 统一响应格式

- **gRPC**: 遵循标准的gRPC状态码和错误模型。
- **HTTP**: Kratos框架会自动将gRPC的错误模型转换为HTTP的JSON响应。我们采纳其默认的错误响应结构，它包含了`code`, `reason`, `message`等字段，符合我们的基本要求。

## 3. 数据库设计规范

### 3.1. 命名约定

- **表名**: **必须**使用小写字母和下划线 `_` 分隔（蛇形命名法 `snake_case`），并使用复数形式。例如 `users`, `group_members`。
- **字段名**: **必须**使用小写字母和下划线 `_` 分隔（蛇形命名法 `snake_case`）。例如 `user_id`, `created_at`。

### 3.2. ORM

- **必须**使用 **GORM** 作为统一的数据库操作库。
- Kratos项目的数据层（`data`层）将负责封装GORM的初始化和操作。

### 3.3. 事务

- 所有涉及多个写操作的业务逻辑**必须**包裹在数据库事务中执行。
- Kratos的`data`层提供了事务管理的封装，业务逻辑应优先使用框架提供的事务能力。

## 4. 编码与架构规范

### 4.1. 项目结构

- **必须**遵循Kratos官方推荐的项目结构（`cmd`, `internal/biz`, `internal/data`, `internal/server`, `internal/service`）。
- **`biz` (Business)**: 存放核心的业务逻辑和领域模型，**不应**包含任何框架或基础设施相关的代码。
- **`data` (Data)**: 负责数据的持久化和访问，与数据库、Redis等交互。
- **`service` (Service)**: 负责实现 `.proto` 文件中定义的gRPC服务，它作为适配层，调用`biz`层完成业务逻辑。

### 4.2. 依赖注入

- **必须**使用Kratos集成的 **Wire** 工具进行依赖注入，以实现组件间的解耦。

## 5. 日志记录规范

### 5.1. 日志组件

- 采用Kratos内置的`log`组件作为统一的日志接口。

### 5.2. 日志输出

- **必须**配置为输出**结构化的JSON格式**日志。
- Kratos的日志组件会自动为每条日志添加`ts` (时间戳), `level` (级别), `caller` (调用位置) 等标准字段。

### 5.3. 上下文信息

- **必须**通过Kratos的`Context`传递链路追踪ID (`trace_id`)、用户ID (`user_id`)等信息，日志组件会自动将这些信息附加到日志中，以便于问题排查。

## 6. 配置管理

- **必须**采用Kratos的`config`组件进行配置加载。
- **配置源**: 支持从本地文件（开发环境）或配置中心（生产环境）加载。
- **本地开发**: 配置文件**必须**放在项目根目录的 `configs` 文件夹下。
- **生产环境**: 所有敏感信息（如数据库密码、API Key）**必须**通过环境变量或配置中心进行管理，严禁硬编码。
